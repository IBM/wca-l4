# **Cluster Preparation**</br>*On-Premises Installation and Deployment*

!!! quote ""
    The following section is based off of IBM Documentation detailing how to prepare an OpenShift cluster for IBM Cloud Pak for Data. Reference the instructions in full at the following resource: <a href="https://www.ibm.com/docs/en/software-hub/5.1.x?topic=installing-preparing-your-cluster" target="_blank">**Preparing Your Cluster for IBM Software Hub**</a>.

## **i. Change the process IDs limit**

1. With a newly installed cluster, a *KubeletConfig* will need to be manually created before the cluster's process IDs can be modified. This file will define the `podPidsLimit` and `maxPods` variables for the environment.

    !!! note "KUBELETCONFIG TEST"
        You can test whether a *KubeletConfig* file exists on the system by executing the following command:

        ``` shell
        oc get kubeletconfig
        ```
    
    Copy the contents of the following code block and then **execute** within your Terminal console to generate a new *KubeletConfig* file:

    ``` shell
    oc apply -f - << EOF
    apiVersion: machineconfiguration.openshift.io/v1
    kind: KubeletConfig
    metadata:
    name: cpd-watsonx-kubeletconfig
    spec:
    kubeletConfig:
        podPidsLimit: 16384
        podsPerCore: 0
        maxPods: 500
    machineConfigPoolSelector:
        matchExpressions:
        - key: pools.operator.machineconfiguration.openshift.io/worker
        operator: Exists
    EOF
    ```

---

2. Use the CP4D command line (`cpd-cli`) to log into OCP by **executing** the following code:

    ``` shell
    cpd-cli manage login-to-ocp \
    --username=${OCP_USERNAME} \
    --password=${OCP_PASSWORD} \
    --server=${OCP_URL}
    ```

    The console will return two `[SUCCESS]` statements indicating that the `login-to-ocp command ran successfully`.

---

## **ii. Update cluster global pull secret**

3. Use `cpd-cli` to manage the creation or updating of the global image pull *secret* via the `add-icr-cred-to-global-pull-secret` command.

    </br>
    **Execute** the following command within the Terminal console:

    ``` shell
    cpd-cli manage add-icr-cred-to-global-pull-secret --entitled_registry_key=${IBM_ENTITLEMENT_KEY} 
    ```

    The console will return two `[SUCCESS]` statements indicating that the command ran successfully.

---

4. Now you must update all nodes across the cluster using OpenShift command line (`oc`).

    </br>
    **Execute** the following instructions via the Terminal console:

    ``` shell
    oc login ${OCP_URL} --username=${OCP_USERNAME} --password=${OCP_PASSWORD}
    oc get mcp
    ```

    Once completed, **execute** the following statement to check the status of the cluster nodes (this can be performed periodically to track the progress of the node updates):

    ``` shell
    cpd-cli manage oc get nodes
    ```

    Wait until the `STATUS` returns for all nodes (3 master nodes, 3 storage nodes, and 3 worker nodes) all report as `Ready`.

---

## **iii. Next steps**

In the following module, you will install the necessary prerequisite software required to deploy IBM Cloud Pak for Data and IBM watsonx Code Assistant.